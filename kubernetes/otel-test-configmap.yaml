apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-test-script
  namespace: testbed
data:
  main.py: |
    import os, time
    from opentelemetry import trace, metrics
    from opentelemetry.sdk.resources import Resource
    from opentelemetry.sdk.trace import TracerProvider
    from opentelemetry.sdk.trace.export import BatchSpanProcessor
    from opentelemetry.exporter.otlp.proto.http.trace_exporter import OTLPSpanExporter
    from opentelemetry.sdk.metrics import MeterProvider
    from opentelemetry.sdk.metrics.export import PeriodicExportingMetricReader
    from opentelemetry.exporter.otlp.proto.http.metric_exporter import OTLPMetricExporter

    service = os.getenv("SERVICE_NAME", "otel-test")
    node = os.getenv("NODE_NAME", "unknown")
    base = os.getenv("OTEL_EXPORTER_OTLP_ENDPOINT", "http://otel-collector.observability:4318").rstrip("/")

    resource = Resource.create({"service.name": service})

    # Traces (OTLP HTTP -> /v1/traces)
    trace.set_tracer_provider(TracerProvider(resource=resource))
    tracer = trace.get_tracer(service)
    span_exporter = OTLPSpanExporter(endpoint=base + "/v1/traces")
    trace.get_tracer_provider().add_span_processor(BatchSpanProcessor(span_exporter))

    # Metrics (OTLP HTTP -> /v1/metrics)
    metric_exporter = OTLPMetricExporter(endpoint=base + "/v1/metrics")
    reader = PeriodicExportingMetricReader(metric_exporter, export_interval_millis=5000)
    metrics.set_meter_provider(MeterProvider(resource=resource, metric_readers=[reader]))
    meter = metrics.get_meter(service)

    counter = meter.create_counter("otel_test_counter", unit="1", description="test counter")

    print(f"Starting OTEL test. base={base} service={service} node={node}")

    i = 0
    while True:
      i += 1
      counter.add(1, {"component": "otel-test", "node": node})
      with tracer.start_as_current_span("otel_test_span") as span:
        span.set_attribute("iteration", i)
        span.set_attribute("node", node)
      print(f"sent iteration {i} node={node}")
      time.sleep(2)
